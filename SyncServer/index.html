<!DOCTYPE html>
<html lang="en">
<!-- 
  QUICK REF LINK  
  https://developer.jwplayer.com/jwplayer/docs/jw8-javascript-api-reference
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://cdn.jwplayer.com/libraries/NMuIi6sP.js"></script>

   <!-- <link rel="stylesheet" href="assets/style.css" />  -->
    <title>WebSockets</title>
</head>

<body>

<table>
  <tr>
    <td colspan="2"><h1 >Sync Server (POC) 0.014 </h1></td> <td></td>   <td></td>   <td></td></tr>
  
  <tr>
    <td>Test Controls:</td></tr>

  <tr>
    <td colspan="2"><input type="text" id="myText" name="myText" value="new msg">
    <button size="20" type="button" onclick="sendMyText()">Send New</button>
    <input type="text" size="50" id="echoText" name="echoText" value="NoSocket">
    <button  size="20" type="button" onclick="sendEchoText()">Edit&Echo</button></td></tr>
<hr>
  <tr>
    <td><button type="button" onclick="joinRoom()">Join Room</button>
    <button type="button" onclick="zeroAll()">Zero All</button>
    <button type="button" onclick="syncAll()">Sync All</button>
      <button type="button" onclick="syncPlay()">Scrub-n-Play</button></td> 
  <tr>
    <td><button type="button" onclick="videoPlay()">Play</button>
    <button type="button" onclick="videoPause()">Pause</button>
    <input size="10" type="text" id="playState" name="playState"></td></tr>

</table>

<hr>

<table  border "2px solid black" width="300px" >
	<col style="width:30%">
	<col style="width:35%">
	<col style="width:35%">
  <thead>
    <tr>
      <th >Timer</th>
      <th>Seconds</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Local T-Code</td>
      <td><input type="text" size="25" id="timeCode"  name="timeCode"></td>
    </tr>
 <!--   <tr>
      <td hidden >Local Timer</td>
      <td><input type="text" size="25" id="timeStamp" name="timeStamp"></td>
    </tr>
-->
    <tr>
      <td>Server Timer</td>
      <td><input type="text" size="25" id="serverStamp" name="serverStamp"></td>
    </tr>
  </tbody>
</table>


<hr>

<table>
  <tr>
    <td><div class="video-player"></div>
    <div id="myElement">Player loading...</div>
            <!-- <a href="javascript:jwplayer('myElement').play();">Toggle playback</a>
            <a href="javascript:alert('The volume of the player is: ' + jwplayer('myElement').getVolume());">Report volume</a>
            -->   
    </td></tr>

</table>
</body>
</html>

<script type="text/JavaScript">

// CHANGE BLOCK: Uncomment desired websocket connection. 
// Adrian Server:  
// const ws = new WebSocket("ws://ec2-18-237-232-102.us-west-2.compute.amazonaws.com:8082");
// Andreas AWS:
const ws = new WebSocket("ws://3.80.109.107:8082");    // Current IP must be updated too.
// Testing on local host:
// const ws = new WebSocket("ws://localhost:8082");
// CHANGE BLOCK END.
// TODO: Move change block to secure config file!!

// Primary JSON data structures used to communicate over web socket.
let ClientData = {
  "eventCode": "CD.eC",   // Action request from client sent to SyncServer.
  "clientTimeCode":  -1,  // Value from JW Player api.     // rename --> JWPlayerTimeCode
  "clientTimeStamp": -1,  // Value from page stopwatch.    // rename --> LocalTimer
  "sendText":"CD.sT",     // Use to sanity check socket connection.
  }

let ServerData = {
  "eventCode": "SD.eC",   // Typically same value as sent by client.
  "serverTimeCode": -1,   // Either an echoed clientTimeCode or server's stopwatch timecode.
  "echoText": "SD.eT",    // Result shown on screen in sanity checking.
  "serverTimerIsRunning": false,  // Return current run state of stopwatch timer.
  }


class StopWatch {
  // A real stopwatch can be repeatedly started and stopped, and as a result it shows a total running time.
  // Similarly this stopwatch class can accumulate a total of the running time intervals.
  // It also has a reset method sets accumulated total to a specific total time.

  constructor () {
    this.startTime = undefined;
    this.totalRunTime = 0;    
    this.isRunning = false;
  }
  
  start () {
    // Set the basis of next running time interval using system time. 
    if (!this.isRunning) {  // Ignore run event if already running.  
      this.startTime = performance.now();
      this.isRunning = true;
    }};

  stop () { 
    // Calculate the amount of time since we last started and add to our total runtime.            
    if (this.isRunning) {   // Ignore stop event if not running.
      this.totalRunTime += performance.now()- this.startTime;
      this.isRunning = false;
    }};

  reset (timeVal) {
    // Initialize stopwatch timer to 0 or an arbitrary point in video.
    // TODO: Add bounds check on timeval (0<=TC<=video length)
    this.startTime=undefined;
    this.totalRunTime = timeVal; 
    this.isRunning = false;  
  };

  getRunTime () {
    let accTime;
    if (this.isRunning) {  
      // Get snapshot of run time, by adding  
      accTime = this.totalRunTime+(performance.now() - this.startTime);
      console.log("Get Time while isRunning");

    } 
    else {
      accTime = this.totalRunTime;
      console.log("Get Time when not Running");
    }
    return accTime;
  };

  getTimeCode() {
    return this.getRunTime()/1000;
  };

  getIsRunning() {
    return this.isRunning;
  };

}

jwplayer("myElement").setup({
  "playlist": [{
  // "file": "https://s3.amazonaws.com/counterbalance-video/stemc1.m4v"
  "file": "https://cdn.jwplayer.com/manifests/TYAYoaiQ.m3u8" 
  }],
  autostart: false,
  //responsive: true,
  //aspectratio: "16:9",  width: 480,  height: 270,
  //mute: false,   volume: 80,
});

let sw = new StopWatch();

// Initiate web socket connection to SyncServer.
ws.addEventListener("open", ()=>{
  ClientData.eventCode="NEW";
  ClientData.sendText="Hello All!";
  ws.send(JSON.stringify(ClientData));
});

//
// Handle messages from SyncServer. 
//
ws.addEventListener("message",({data}) =>{      
  ServerData = JSON.parse(data);

  switch (ServerData.eventCode) {
    case 'SENDTEXT':
      document.getElementById("echoText").value = ServerData.echoText; 
      break;

    case 'ECHOTEXT':
      document.getElementById("echoText").value = ServerData.echoText; 
      break;

    case 'PLAY':
      if (jwplayer("myElement").getState()=="paused") {
        jwplayer("myElement").play();
      }

      sw.start();

      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();
      break; 

    case 'NEW':
      jwplayer("myElement").seek(ServerData.serverTimeCode);
      sw.reset(ServerData.serverTimeCode);
 
      if (ServerData.serverTimerIsRunning == true) {
        if (jwplayer("myElement").getState()!="play") {  
        //TODO: Kludge if player not ready.. Handling all preplay states? Async video load?
        // setTimeout(jwplayer("myElement").play(),60000);
        jwplayer("myElement").play()
        sw.start();     
      }  }

      document.getElementById("echoText").value = ServerData.echoText;
      setTimerDisplays();           
      break; 

    case 'JOIN':
      jwplayer("myElement").seek(ServerData.serverTimeCode);
      sw.reset(ServerData.serverTimeCode);

      if (ServerData.serverTimerIsRunning == true) {
        if (jwplayer("myElement").getState()=="paused") {  

          jwplayer("myElement").play();
       //   sw.start();         
      }}

      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();           
      break; 

    case 'PAUSE':
      if (jwplayer("myElement").getState()=="playing") {
        jwplayer("myElement").pause();
      }
      sw.stop();

      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();
      break;

    case 'SYNCALL':
      jwplayer("myElement").seek(ServerData.serverTimeCode);
 
      if (jwplayer("myElement").getState()=="playing") {
        jwplayer("myElement").pause();
      }

      sw.reset(ServerData.serverTimeCode);

      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();
      break;

    case 'SYNCPLAY':
      jwplayer("myElement").seek(ServerData.serverTimeCode);
      if (jwplayer("myElement").getState()=="paused") {
        jwplayer("myElement").play();
      }

      sw.reset(ServerData.serverTimeCode);

      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();
      break;


    case 'ZEROALL':
      if (jwplayer("myElement").getState()=="playing") {
        jwplayer("myElement").pause();
      }

      jwplayer("myElement").seek(ServerData.serverTimeCode);
      sw.reset(ServerData.serverTimeCode);

      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();
      break;


    default:
      document.getElementById("playState").value = ServerData.eventCode;
      setTimerDisplays();    }
  });

//
// SUPPORT FUNCTIONS
//
function setTimerDisplays () {
  document.getElementById("timeCode").value = jwplayer("myElement").getPosition();
  // document.getElementById("timeStamp").value = sw.getTimeCode();
  document.getElementById("serverStamp").value = ServerData.serverTimeCode;
}

function sendMyText() {
  ClientData.eventCode = "SENDTEXT";
  ClientData.sendText = document.getElementById("myText").value;

  ws.send(JSON.stringify(ClientData));
}

function sendEchoText() {
  ClientData.eventCode = "ECHOTEXT";
  ClientData.sendText = document.getElementById("echoText").value;

  ws.send(JSON.stringify(ClientData));
}

function videoPlay() {
  ClientData.eventCode = "PLAY";
 // ClientData.clientTimeCode = jwplayer("myElement").getPosition;
 // ClientData.clientTimeStamp = sw.getTimeCode();
  ClientData.sendText="N/A";

  ws.send(JSON.stringify(ClientData));
}

function videoPause() {
  ClientData.eventCode = "PAUSE";
 // ClientData.clientTimeCode = jwplayer("myElement").getPosition;
 // ClientData.clientTimeStamp = sw.getTimeCode();
  ClientData.sendText="N/A";

  ws.send(JSON.stringify(ClientData));
}

function joinRoom() {
  ClientData.eventCode = "JOIN";
 // ClientData.clientTimeCode= -1;
// ClientData.clientTimeStamp = -1;
  ClientData.sendText = "N/A";

  ws.send(JSON.stringify(ClientData));
}

function syncAll() {
  // Reset timers and video on all clients to this client's timecode e.g. after scrubbing.
  // Action steps occur in server and client handlers for this eventCode.  
  ClientData.eventCode = "SYNCALL";
  ClientData.clientTimeCode = jwplayer("myElement").getPosition(); //  Math.trunc(jwplayer("myElement").getPosition()*100);
//  ClientData.clientTimeStamp = sw.getTimeCode();
  ClientData.sendText="N/A";

  setTimerDisplays();
  ws.send(JSON.stringify(ClientData));
}

function syncPlay() {
  // Reset timers and video on all clients to this client's timecode.
  // Automatically resume video playing for all.
  // Action steps occur in server and client handlers for this eventCode.  
  ClientData.eventCode = "SYNCPLAY";
  ClientData.clientTimeCode = jwplayer("myElement").getPosition(); //  Math.trunc(jwplayer("myElement").getPosition()*100);
//  ClientData.clientTimeStamp = sw.getTimeCode();
  ClientData.sendText="N/A";

  setTimerDisplays();
  ws.send(JSON.stringify(ClientData));
}

function zeroAll () {
  // Reset timers and video to 0 seconds for all clients. Pause all video playing.
  // Action steps occur in server and client handlers for this eventCode.  
  ClientData.eventCode = "ZEROALL";
  ClientData.clientTimeCode= 0;
 // ClientData.clientTimeStamp = sw.getTimeCode();
  ClientData.sendText = "N/A";

  ws.send(JSON.stringify(ClientData));
}

</script>

