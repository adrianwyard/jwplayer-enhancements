<!DOCTYPE html>
<html lang="en">
<!-- 
  QUICK REF LINK  
  https://developer.jwplayer.com/jwplayer/docs/jw8-javascript-api-reference
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://cdn.jwplayer.com/libraries/NMuIi6sP.js"></script>

   <!-- <link rel="stylesheet" href="assets/style.css" />  -->
    <title>WebSockets</title>
</head>

<body>

<table>
  <tr>
  <td colspan="2"><h1 >Sync Server (POC) 0.01 </h1></td>
  </tr>
  <tr>
  <td><h2>Test Controls:<h2></td>  
 </tr>

 <tr>
  <td><hr></td>   <td><hr></td>   <td><hr></td>   <td><hr></td>  <td><hr></td>
  </tr>


  <tr>
    <td colspan="2"><input type="text" id="myText" name="myText" value="new msg">
    <button size="20" type="button" onclick="sendMyText()">Send New</button> </td>
    <td colspan="2"><input type="text" size="50" id="echoText" name="echoText" value="NoSocket">
    <button  size="20" type="button" onclick="sendEchoText()">Edit&Echo</button></td>
  </tr>
  <tr>
  <td><hr></td>   <td><hr></td>   <td><hr></td>   <td><hr></td>  <td><hr></td>
  </tr>
  <tr>     <td> <button type="button" onclick="joinRoom()">Join Room</button></td>  <td></td>  <tr><hr></tr>
  <tr>
    <td><button type="button" onclick="videoPlay()">Play</button>
    <button type="button" onclick="videoPause()">Pause</button>
    <input size="10" type="text" id="playState" name="playState"></td>
    <td></td><td></td>
    <td> <button type="button" onclick="videoSync()">Sync All</button>
    <input type="text" size="15" id="timeBox"></td>

     <td></td>
    <td> <button type="button" onclick="NewRoom()">New Room</button> </td>


  </tr>
</table>

<table>
<tr>
<td>
   <div class="video-player">

<div id="myElement">Player loading...</div>
 </div>
<!-- <a href="javascript:jwplayer('myElement').play();">Toggle playback</a>
<a href="javascript:alert('The volume of the player is: ' + jwplayer('myElement').getVolume());">Report volume</a>
-->   
</td>
</tr>
</table>

<!-- JW Player Code-->
<script type="text/JavaScript">
    jwplayer("myElement").setup({
	    "playlist": [{
       "file": "https://s3.amazonaws.com/counterbalance-video/stemc1.m4v"
      //"file": "https://cdn.jwplayer.com/manifests/TYAYoaiQ.m3u8"

      }],
//responsive: true,
//width: "50%",
//aspectratio: "16:9",
 //     width: 480,
   //  height: 270,
    autostart: true,
  //  mute: false,
  //  volume: 80,
      });

//jwplayer("myElement").on('ready');

   // jwplayer("myElement").resize(480, 470);
  // jwplayer("myElement").play(false);

    // Related to sticky play issue.
    // jwplayer("myElement").seek(1);
    //jwplayer("myElement").play();
</script>

 
<!-- WS Script Core Socket Code -->
 <script type="text/JavaScript">
    let startTime = Date.now();

    let ClientData = {
      "eventCode":"",
      "clientTimeCode":0,
      "clientTimeStamp":0,
      "clientDate":startTime,
      "sendText":"na",
      }

    let ServerData = {
      "eventCode":"",
      "serverTimeCode":0,
      "serverTimeStamp":0,
      "echoText":"na",
      }

    // CHANGE WEBSOCKET IP FOR AWS DEPLOY!!! //
    //AdrianServer  // const ws = new WebSocket("ws://ec2-18-237-232-102.us-west-2.compute.amazonaws.com:8082");
    //  const ws = new WebSocket("ws://52.90.223.117:8082");    // CHANGE IP TO CURRENT //
    const ws = new WebSocket("ws://localhost:8082");
    // END OF CHANGE BLOCK //

    // Initiate a connect to SyncServer
    ws.addEventListener("open", ()=>{
      ClientData.eventCode="NEW";
      ClientData.sendText="Hello All!";

      let payload = JSON.stringify(ClientData); 
      ws.send(payload);
      });

    // Process new SyncServer message 
    ws.addEventListener("message",({data}) =>{      
      ServerData = JSON.parse(data);
      data = ServerData.eventCode;

      switch (ServerData.eventCode) {
        case 'PLAY':
          jwplayer("myElement").play();
          document.getElementById("playState").value = ServerData.eventCode;
          break; 
        case 'NEW':
          jwplayer("myElement").seek(ServerData.serverTimeCode);
       //   jwplayer("myElement").pause();
          jwplayer("myElement").play();
          document.getElementById("playState").value = ServerData.eventCode;
          document.getElementById("echoText").value = ServerData.echoText;
          break; 
        case 'PAUSE':
          jwplayer("myElement").pause();
          document.getElementById("playState").value = ServerData.eventCode;
          break;
        case 'SYNCALL':
          jwplayer("myElement").seek(ServerData.serverTimeCode);
          document.getElementById("timeBox").value = ServerData.serverTimeCode;
          jwplayer("myElement").pause();
          jwplayer("myElement").play();
          break;

        default:
          document.getElementById("echoText").value = ServerData.echoText;
        }
      });
 
    function sendMyText() {
            ClientData.eventCode = "SENDTEXT";
      let currentTime = Date.now();
      ClientData.clientTimeStamp = currentTime - startTime;
      ClientData.clientDate;
      ClientData.sendText = document.getElementById("myText").value;
      let payload = JSON.stringify(ClientData);
      // let payload = document.getElementById("myText").value;
      ws.send(payload);
    }

    function sendEchoText() {
      ClientData.eventCode = "ECHOTEXT";
      ClientData.sendText = document.getElementById("echoText").value;
    
      let payload = JSON.stringify(ClientData);
    // let payload = document.getElementById("echoText").value;
      ws.send(payload);
    }

   function videoPlay() {
      ClientData.eventCode = "PLAY";
      let payload = JSON.stringify(ClientData);
      ws.send(payload);
    }

   function videoPause() {
      ClientData.eventCode = "PAUSE";
      let payload = JSON.stringify(ClientData);
      ws.send(payload);
    }

    function videoSync() {
      ClientData.eventCode = "SYNCALL";
      ClientData.clientTimeCode= jwplayer("myElement").getPosition();
      let payload = JSON.stringify(ClientData);
      ws.send(payload);
    }
  function joinRoom() {
      ClientData.eventCode = "NEW";
      let payload = JSON.stringify(ClientData);
      ws.send(payload);
    }


  </script>

